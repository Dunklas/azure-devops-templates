parameters:
  poolVmImage: "ubuntu-16.04"
  poolName: ""
  sourceBranch: "refs/heads/master"
  dockerfilePath: "./Dockerfile"
  serviceName: ""
stages:
  - stage: build
    jobs:
      - job: image
        pool:
          ${{ if not(eq(parameters.poolName, '')) }}:
            name: ${{ parameters.poolName }}
          ${{ if not(eq(parameters.vmImage, '')) }}:
            vmImage: ${{ parameters.vmImage }}
        continueOnError: false
        steps:
          - variables:
              serviceName: "${{ coalesce(parameters.serviceName, Build.Repository.Name) }}"

          - bash: |
              set -e
              shortHash=${sourceVersion:0:7}
              echo "Long commit hash: ${sourceVersion}"
              echo "Short commit hash: ${shortHash}"
              echo "##vso[task.setvariable variable=shortHash]$shortHash"
            displayName: "Generate short commit hash (7-char git hash)"
            env:
              sourceVersion: $(Build.SourceVersion)

          - bash: |
              set -e
              set -x
              docker build -f ${{ parameters.dockerfilePath }} -t $(serviceName):$(shortHash) .
              docker save $(serviceName):$(shortHash) | gzip > $(serviceName)_$(shortHash).tar.gz
            displayName: "Build and save image"
            condition: and(succeeded(), eq(variables['Build.sourceBranch'], '${{ parameters.sourceBranch }}'))

          - task: PublishPipelineArtifact@1
            displayName: "Publish Azure Pipelines Artifact"
            inputs:
              targetPath: $(serviceName)_$(shortHash).tar.gz
              artifactName: $(serviceName)
            condition: and(succeeded(), eq(variables['Build.sourceBranch'], '${{ parameters.sourceBranch }}'))
